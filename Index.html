<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Dino Quest ‚Äî Tout-en-un</title>

<style>
:root{
  --bg:#0b0f14; --panel:#0f1622; --border:#1f2937; --txt:#eef1f6; --muted:#9aa4b2;
  --hp:#22d3ee; --gold:#f6c960; --gems:#7dd3fc; --ring:#0c1320; --accent:#8b5cf6;
}
*{box-sizing:border-box} html,body{margin:0}
body{background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;min-height:100vh;overflow:hidden}

/* HUD top */
.top{position:fixed;top:0;left:0;right:0;height:56px;display:flex;align-items:center;justify-content:space-between;
  padding:0 12px;background:linear-gradient(180deg,#0f1622,#0b0f14);border-bottom:1px solid var(--border);z-index:40}
.brand{font-weight:800;letter-spacing:.5px}
.hud{display:flex;gap:10px;align-items:center;font-weight:700}
.badge{padding:6px 10px;border:1px solid var(--border);border-radius:12px;background:var(--panel);display:flex;gap:6px;align-items:center}
.g{color:var(--gold)} .j{color:var(--gems)}
.ham{width:34px;height:34px;border-radius:10px;border:1px solid var(--border);background:var(--panel);display:grid;place-items:center;cursor:pointer}
.ham div{width:16px;height:2px;background:#cfd6e3;margin:2px 0}

/* Stage / combat */
.stage{position:absolute;inset:56px 0 0 0;display:grid;place-items:center;
  background: radial-gradient(1200px 800px at 50% 20%, #122233 0%, rgba(17,24,39,0) 55%) , linear-gradient(180deg,#0d1622 0%, #0b0f14 60%);}
.scene{position:relative;width:min(100vw,780px);height:min(100vh - 56px,560px)}
.ring{position:absolute;border-radius:999px;background:radial-gradient(closest-side, #131d2b 0%, var(--ring) 60%, transparent 62%);filter:blur(0.2px)}
.ring.enemy{width:36%;aspect-ratio:1/0.3;right:6%;top:12%}
.ring.ally{width:44%;aspect-ratio:1/0.32;left:6%;bottom:8%}
.sprite{position:absolute;transform-origin:center;filter:drop-shadow(0 18px 24px rgba(0,0,0,.55));z-index:2}
.sprite.enemy{right:10%;top:6%;font-size:72px}
.sprite.ally{left:12%;bottom:12%;font-size:76px}
.box{position:absolute;right:6%;top:6%;width:44%;background:rgba(10,13,18,.75);backdrop-filter:blur(4px);
  border:1px solid var(--border);border-radius:12px;padding:10px;z-index:1}
.name{font-weight:800;margin-bottom:6px}
.bar{height:12px;background:#0a0d12;border:1px solid var(--border);border-radius:999px;overflow:hidden}
.fill{height:100%;background:linear-gradient(90deg,var(--hp),#38bdf8);width:100%}
.statrow{display:flex;gap:8px;margin-top:8px;font-size:12px;color:var(--muted)}
.box-ally{position:absolute;left:6%;bottom:6%;width:46%;background:rgba(10,13,18,.75);
  border:1px solid var(--border);border-radius:12px;padding:10px}
.hint{position:absolute;left:50%;transform:translateX(-50%);bottom:10px;color:var(--muted);font-size:12px}
.speed{position:absolute;left:6%;top:6%;display:flex;gap:6px}
.btn{background:#1f2937;border:1px solid #2c3646;color:var(--txt);padding:6px 10px;border-radius:10px;cursor:pointer}
.btn:active{transform:translateY(1px)}
.log{position:absolute;left:6%;top:48%;background:rgba(10,13,18,.75);border:1px solid var(--border);padding:6px 10px;border-radius:10px;color:var(--muted);font-size:12px}
.hit{animation:hit .12s ease}@keyframes hit{from{transform:translateX(0)}50%{transform:translateX(-2px)}to{transform:translateX(0)}

/* Menu + Panel */
.menu{position:fixed;top:56px;right:12px;z-index:50;background:rgba(10,13,18,.95);border:1px solid var(--border);
  border-radius:12px;min-width:210px;display:none}
.menu.open{display:block}
.menu a{display:block;padding:12px 14px;border-bottom:1px solid var(--border);text-decoration:none;color:var(--txt)}
.menu a:last-child{border-bottom:0}
.menu a:active{background:#141c29}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:60}
.panel{position:fixed;inset:auto 0 0 0;min-height:60%;background:#0f1622;border-top:1px solid var(--border);border-radius:16px 16px 0 0;display:none;z-index:61;padding:12px}
.overlay.show{display:block} .panel.show{display:block}
.panel .tabs{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
.chip{padding:8px 12px;border:1px solid var(--border);border-radius:999px;cursor:pointer;background:#111a28}
.chip.active{background:#1b2940}
.sec{display:none} .sec.active{display:block}
.grid-5{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:8px}
.grid-6{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:8px}
.slot{background:#0a111b;border:1px solid var(--border);border-radius:12px;padding:8px;text-align:center}
.slot .big{font-size:28px}
.sub{font-size:12px;color:var(--muted)}
.badgeR{display:inline-block;margin-top:4px;padding:2px 6px;border:1px solid var(--border);border-radius:999px;font-size:11px}
.r-basic{background:#2a2d34}.r-rare{background:#1d2b52}.r-epic{background:#30204f}.r-legendary{background:#402a17}.r-supreme{background:#4c1414}
.center{display:flex;gap:8px;align-items:center;justify-content:center;margin:8px 0}
.note{color:var(--muted);font-size:12px;text-align:center;margin:6px 0}
.sep{height:1px;background:#1f2937;margin:8px 0}

/* √âquipement */
.grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
.slotHead{font-weight:700;margin-bottom:6px;text-align:center}
.eqCard{background:#0a111b;border:1px solid var(--border);border-radius:12px;padding:8px;text-align:center;min-height:88px}
.eqCard .big{font-size:26px}
.eqEmpty{opacity:.6}
.eqList{max-height:200px;overflow:auto;margin-top:8px}
.eqItem{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border:1px solid var(--border);border-radius:10px;margin:6px 0;background:#0f1826}
.eqItem small{opacity:.7}

/* Classeur */
h3{margin:6px 0 8px}
.dex-card{background:#0a111b;border:1px solid var(--border);border-radius:12px;min-height:72px;display:grid;place-items:center;padding:6px;text-align:center}
.dex-card .big{font-size:26px}
.locked{opacity:.35;filter:grayscale(100%)}
.tag{display:inline-block;margin-top:4px;padding:2px 6px;border:1px solid var(--border);border-radius:999px;font-size:11px}
.tag.basic{background:#2a2d34}.tag.rare{background:#1d2b52}.tag.epic{background:#30204f}.tag.legend{background:#402a17}.tag.supreme{background:#4c1414}
</style>
</head>
<body>

<!-- HUD -->
<div class="top">
  <div class="brand">Dino Quest</div>
  <div class="hud">
    <div class="badge"><span>Lvl</span>&nbsp;<span id="lvl">1</span></div>
    <div class="badge g">‚õÅ <span id="gold">0</span></div>
    <div class="badge j">üíé <span id="gems">0</span></div>
    <div id="ham" class="ham" aria-label="menu"><div></div><div></div><div></div></div>
  </div>
</div>

<!-- Menu -->
<nav id="menu" class="menu">
  <a href="#" data-tab="improve">Am√©liorations</a>
  <a href="#" data-tab="summon">Tirage</a>
  <a href="#" data-tab="bag">Inventaire</a>
  <a href="#" data-tab="dex">Classeur</a>
  <a href="#" data-tab="equip">√âquipement</a>
  <a href="#" data-tab="promo">Code Promo</a>
</nav>

<!-- Sc√®ne de combat -->
<div class="stage">
  <div class="scene">
    <div class="ring enemy"></div>
    <div class="ring ally"></div>

    <div id="enemySprite" class="sprite enemy">ü¶Ç</div>
    <div id="allySprite" class="sprite ally">ü¶ï</div>

    <div class="box">
      <div id="enemyName" class="name">Niv. 1 ‚Äî L√©zard Sauvage</div>
      <div class="bar"><div id="enemyBar" class="fill"></div></div>
      <div class="statrow"><span>ATK <span id="eAtk">0</span></span><span>DEF <span id="eDef">0</span></span></div>
    </div>

    <div class="box-ally">
      <div class="name" id="allyName">Petit Raptor ‚Äî BASIC</div>
      <div class="bar"><div id="allyBar" class="fill"></div></div>
      <div class="statrow"><span>PV <span id="aHp">0</span>/<span id="aHpM">0</span></span><span>ATK <span id="aAtk">0</span></span><span>DEF <span id="aDef">0</span></span></div>
    </div>

    <div class="speed">
      <button class="btn" id="s1">x1</button>
      <button class="btn" id="s2">x2</button>
      <button class="btn" id="s3">x3</button>
    </div>

    <div id="log" class="log">Combat auto ‚Äî boss tous les 10 niveaux (+10 gemmes). D√©faite = on recommence le niveau.</div>
    <div class="hint">‚ò∞ ‚Üí Am√©liorations / Tirage / Inventaire / Classeur / √âquipement / Code Promo</div>
  </div>
</div>

<!-- Overlay + Panel -->
<div id="overlay" class="overlay"></div>
<div id="panel" class="panel">
  <div class="tabs">
    <div class="chip" data-tab="improve">Am√©liorations</div>
    <div class="chip" data-tab="summon">Tirage</div>
    <div class="chip" data-tab="bag">Inventaire</div>
    <div class="chip" data-tab="dex">Classeur</div>
    <div class="chip" data-tab="equip">√âquipement</div>
    <div class="chip" data-tab="promo">Code Promo</div>
    <div style="margin-left:auto" class="chip" id="closePanel">Fermer</div>
  </div>

  <!-- Am√©liorations -->
  <div id="sec-improve" class="sec">
    <div class="note">Appuie sur un slot pour choisir un dino (vide) ou ouvrir l‚Äô√©quipement du dino (occup√©).</div>
    <div id="teamGrid" class="grid-5"></div>
    <div class="sep"></div>
    <div class="note">Collection d√©bloqu√©e (via tirage) :</div>
    <div id="collectionGrid" class="grid-5"></div>
  </div>

  <!-- Tirage -->
  <div id="sec-summon" class="sec">
    <div class="center">
      <button class="btn" id="pull1">Tirage Dino (100üíé)</button>
      <button class="btn" id="pull10">Tirage Dino x10 (1000üíé)</button>
    </div>
    <div class="note">Taux: BASIC 60% ‚Ä¢ RARE 25% ‚Ä¢ EPIC 10% ‚Ä¢ LEGEND 4% ‚Ä¢ SUPREME 1%</div>
    <div id="pullResults" class="grid-5" style="margin-top:8px"></div>

    <div class="sep"></div>
    <h3>Coffres d‚Äôobjets (or)</h3>
    <div class="center" style="flex-wrap:wrap">
      <button class="btn" onclick="doChest('BASIC')">Coffre Basique (1000‚õÅ)</button>
      <button class="btn" onclick="doChest('RARE')">Coffre Rare (5000‚õÅ)</button>
      <button class="btn" onclick="doChest('SUPREME')">Coffre Supr√™me (15000‚õÅ)</button>
    </div>
    <div id="chestResults" class="grid-5" style="margin-top:8px"></div>
  </div>

  <!-- Inventaire -->
  <div id="sec-bag" class="sec">
    <div class="note">Objets √©quipables (6 par ligne). Un objet √©quip√© est marqu√© et indisponible.</div>
    <div id="bagGrid" class="grid-6"></div>
  </div>

  <!-- Classeur -->
  <div id="sec-dex" class="sec">
    <div class="note">Tout ce que tu peux d√©bloquer. Les gris√©s ne sont pas encore obtenus.</div>
    <h3>Dinos</h3>
    <div id="dexDinos" class="grid-6"></div>
    <div class="sep"></div>
    <h3>Am√©liorations</h3>
    <div id="dexUpgrades" class="grid-6"></div>
  </div>

  <!-- √âquipement -->
  <div id="sec-equip" class="sec">
    <div class="note">√âquipe ton dinosaure : 1 arme + 1 armure + 1 amulette.</div>
    <div id="equipTarget" class="note" style="margin-bottom:8px;"></div>

    <div class="grid-3">
      <div>
        <div class="slotHead">Arme</div>
        <div id="eq-weapon" class="eqCard eqEmpty"><div class="big">üó°Ô∏è</div><div>Aucune</div></div>
        <div class="center">
          <button class="btn" onclick="openEquipList('weapon')">√âquiper</button>
          <button class="btn" onclick="unequipFromSlot('weapon')">Retirer</button>
        </div>
      </div>
      <div>
        <div class="slotHead">Armure</div>
        <div id="eq-armor" class="eqCard eqEmpty"><div class="big">üõ°Ô∏è</div><div>Aucune</div></div>
        <div class="center">
          <button class="btn" onclick="openEquipList('armor')">√âquiper</button>
          <button class="btn" onclick="unequipFromSlot('armor')">Retirer</button>
        </div>
      </div>
      <div>
        <div class="slotHead">Amulette</div>
        <div id="eq-amulet" class="eqCard eqEmpty"><div class="big">üîÆ</div><div>Aucune</div></div>
        <div class="center">
          <button class="btn" onclick="openEquipList('amulet')">√âquiper</button>
          <button class="btn" onclick="unequipFromSlot('amulet')">Retirer</button>
        </div>
      </div>
    </div>

    <div id="eqListWrap" class="eqList"></div>
  </div>

  <!-- Code Promo -->
  <div id="sec-promo" class="sec">
    <div class="note">Entre un code promo pour recevoir ta r√©compense (1 fois / code).</div>
    <input id="promoInput" placeholder="Entrez le code..." style="width:100%;padding:8px;margin:8px 0;">
    <button class="btn" onclick="redeemPromo()">Valider</button>
  </div>
</div>

<script>
/* ===== Helpers & State ===== */
const $ = (id)=>document.getElementById(id);
const fmt = (n)=>Math.floor(n).toLocaleString('fr-FR');
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

const S = {
  lvl:1, gold:0, gems:0, speed:1,
  ally:{ name:"Petit Raptor", rarity:"BASIC", emoji:"ü¶ï", hpMax:120, hp:120, atk:8, def:2, atkRate:1.2, eq:{weapon:null,armor:null,amulet:null} },
  enemy:{ name:"", hpMax:50, hp:50, atk:4, def:0, boss:false, emoji:"ü¶Ç" },
  team:[null,null,null,null,null],          // 5 slots
  collection:[],                             // dinos poss√©d√©s
  items:[],                                  // objets
  usedCodes:[],                              // codes promo utilis√©s
  _tA:0, _tE:0, last: performance.now()
};

const save = ()=>localStorage.setItem('dq_allin_v1', JSON.stringify(S));
const load = ()=>{ try{ const x=JSON.parse(localStorage.getItem('dq_allin_v1')||'null'); if(x) Object.assign(S,x);}catch{} };

/* ===== Mondes (fonds) ===== */
const WORLD_BG = {
  forest:'linear-gradient(180deg,#123a2a,#0b0f14),url("data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 400 300\'><rect width=\'400\' height=\'300\' fill=\'%23133b2c\'/><circle cx=\'50\' cy=\'240\' r=\'40\' fill=\'%231a4b38\'/><circle cx=\'180\' cy=\'250\' r=\'50\' fill=\'%231a4b38\'/><circle cx=\'320\' cy=\'235\' r=\'35\' fill=\'%231a4b38\'/></svg>")',
  desert:'linear-gradient(180deg,#3b2a12,#0b0f14),url("data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 400 300\'><rect width=\'400\' height=\'300\' fill=\'%233b2a12\'/><rect y=\'230\' width=\'400\' height=\'70\' fill=\'%235a401b\'/></svg>")',
  volcano:'linear-gradient(180deg,#3a1717,#0b0f14),url("data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 400 300\'><rect width=\'400\' height=\'300\' fill=\'%233a1717\'/><polygon points=\'50,230 120,120 190,230\' fill=\'%23522a2a\'/><polygon points=\'160,240 220,140 280,240\' fill=\'%23522a2a\'/></svg>")',
  glacier:'linear-gradient(180deg,#153246,#0b0f14),url("data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 400 300\'><rect width=\'400\' height=\'300\' fill=\'%23153246\'/><polygon points=\'40,240 100,150 160,240\' fill=\'%2320415a\'/><polygon points=\'220,240 280,160 340,240\' fill=\'%2320415a\'/></svg>")',
  boss:'linear-gradient(180deg,#26211a,#0b0f14)'
};
function worldForLevel(lv){
  if(lv%10===0) return 'boss';
  if(lv<=10) return 'forest';
  if(lv<=20) return 'desert';
  if(lv<=30) return 'volcano';
  return 'glacier';
}
function setWorld(lv){
  const w = worldForLevel(lv);
  document.querySelector('.stage').style.background =
    `radial-gradient(1200px 800px at 50% 20%, #122233 0%, rgba(17,24,39,0) 55%), ${WORLD_BG[w]}`;
}

/* ===== Bestiaire combat (affichage ennemi) ===== */
const ENEMIES = [
  { name:"Raptor Agile", emoji:"ü¶ñ", atk:1.0, def:0.8, hp:1.0 },
  { name:"Sauropode Paisible", emoji:"ü¶ï", atk:0.8, def:1.0, hp:1.2 },
  { name:"Drake Rugissant", emoji:"üê≤", atk:1.2, def:1.0, hp:1.0 },
  { name:"Cuiracier Fossile", emoji:"ü¶é", atk:0.9, def:1.1, hp:1.1 },
  { name:"Spino des Cendres", emoji:"üêâ", atk:1.3, def:1.0, hp:1.1 }
];
const BOSSES = [
  { name:"BOSS ‚Äî Rex Antique", emoji:"ü¶ñ", atk:1.6, def:1.3, hp:1.8 },
  { name:"BOSS ‚Äî Alpha Spino", emoji:"üêâ", atk:1.7, def:1.2, hp:1.7 },
  { name:"BOSS ‚Äî Titan Cuiracier", emoji:"ü¶é", atk:1.4, def:1.6, hp:1.9 },
  { name:"BOSS ‚Äî Seigneur Glacia", emoji:"üê≤", atk:1.5, def:1.4, hp:1.8 },
  { name:"BOSS ‚Äî Roi Magma", emoji:"üêâ", atk:1.8, def:1.3, hp:2.0 }
];
function newEnemy(){
  const lv = S.lvl;
  const boss = lv % 10 === 0;
  const baseHp = 70 + lv*22;
  const baseAtk = 5 + Math.floor(lv/3);
  const baseDef = Math.floor(lv/12);
  const chosen = boss ? BOSSES[(Math.floor(lv/10)-1) % BOSSES.length]
                      : ENEMIES[ lv % ENEMIES.length ];
  const hp = Math.floor(baseHp * (boss ? 1.6 : chosen.hp));
  const atk = Math.max(1, Math.floor(baseAtk * (boss ? 1.4 : chosen.atk)));
  const def = Math.max(0, Math.floor((baseDef + (boss?2:0)) * (boss ? 1.3 : chosen.def)));

  S.enemy = { name: boss ? chosen.name : `Niv. ${lv} ‚Äî ${chosen.name}`, hpMax: hp, hp: hp, atk: atk, def: def, boss, emoji: chosen.emoji };
  $('enemyName').textContent = S.enemy.name;
  $('enemyBar').style.width = '100%';
  $('enemySprite').textContent = S.enemy.emoji;
  $('eAtk').textContent = S.enemy.atk; $('eDef').textContent = S.enemy.def;
  $('lvl').textContent = S.lvl;
  setWorld(lv);
  save();
}

/* ===== Gacha Dinos ===== */
const POOL = [
  // BASIC (d√©part)
  { key:"b_raptor", name:"Petit Raptor", emoji:"ü¶ï", rarity:"BASIC", base:{hp:120, atk:8,  def:2,  rate:1.2} },

  // RARE (5)
  { key:"r_raptor_agile",   name:"Raptor Agile",     emoji:"ü¶ñ", rarity:"RARE",   base:{hp:160, atk:12, def:4,  rate:1.15} },
  { key:"r_stegosprint",    name:"Stego Sprint",     emoji:"ü¶ï", rarity:"RARE",   base:{hp:175, atk:11, def:5,  rate:1.2} },
  { key:"r_pachyfrappe",    name:"Pachy Frappe",     emoji:"ü¶é", rarity:"RARE",   base:{hp:165, atk:13, def:3,  rate:1.1} },
  { key:"r_spinolette",     name:"Spinolette",       emoji:"ü¶ñ", rarity:"RARE",   base:{hp:170, atk:12, def:4,  rate:1.12} },
  { key:"r_anky_sentinelle",name:"Anky Sentinelle",  emoji:"ü¶é", rarity:"RARE",   base:{hp:185, atk:10, def:6,  rate:1.25} },

  // EPIC (4)
  { key:"e_triceracorps",   name:"Tric√©racorps",     emoji:"ü¶ï", rarity:"EPIC",   base:{hp:230, atk:16, def:8,  rate:1.2} },
  { key:"e_baryon_dash",    name:"Baryon Dash",      emoji:"ü¶ñ", rarity:"EPIC",   base:{hp:220, atk:18, def:7,  rate:1.05} },
  { key:"e_kentro_guard",   name:"Kentrogarde",      emoji:"ü¶é", rarity:"EPIC",   base:{hp:245, atk:15, def:9,  rate:1.18} },
  { key:"e_cerato_eclair",  name:"C√©rato √âclair",    emoji:"ü¶ñ", rarity:"EPIC",   base:{hp:225, atk:19, def:6,  rate:1.0} },

  // LEGEND (3)
  { key:"l_trex_alpha",     name:"T-Rex Alpha",      emoji:"ü¶ñ", rarity:"LEGEND", base:{hp:300, atk:24, def:10, rate:0.95} },
  { key:"l_spino_royal",    name:"Spino Royal",      emoji:"üêâ", rarity:"LEGEND", base:{hp:285, atk:26, def:9,  rate:0.95} },
  { key:"l_giga_roc",       name:"Giga Roc",         emoji:"ü¶ñ", rarity:"LEGEND", base:{hp:320, atk:23, def:12, rate:1.05} },

  // SUPREME (1)
  { key:"s_dragon_ancien",  name:"Dragon Ancien",    emoji:"üê≤", rarity:"SUPREME",base:{hp:380, atk:32, def:14, rate:0.9} },
];
const RATES = [
  { r:"SUPREME", p:1 },
  { r:"LEGEND",  p:4 },
  { r:"EPIC",    p:10 },
  { r:"RARE",    p:25 },
  { r:"BASIC",   p:60 }
];
function pickRarity(){
  const roll = Math.random()*100; let acc=0;
  for(const e of RATES){ acc += e.p; if(roll <= acc) return e.r; }
  return "BASIC";
}
function poolByRarity(r){ return POOL.filter(d=>d.rarity===r); }
function cloneDino(t){
  return {
    id: Date.now().toString(36)+Math.random().toString(36).slice(2,7),
    name: t.name, emoji: t.emoji, rarity: t.rarity,
    hpMax: t.base.hp, hp: t.base.hp, atk: t.base.atk, def: t.base.def, atkRate: t.base.rate,
    eq:{weapon:null,armor:null,amulet:null}
  };
}

/* ===== Coffres d‚Äôobjets (√©quipables) ===== */
const ITEM_POOL = {
  BASIC: [
    { key:"wp_basic", name:"√âp√©e en bois",    rarity:"BASIC",  slot:"weapon" },
    { key:"ar_basic", name:"Bouclier simple", rarity:"BASIC",  slot:"armor"  },
    { key:"am_basic", name:"Amulette terne",  rarity:"BASIC",  slot:"amulet" },
    { key:"wp_stone", name:"Marteau pierre",  rarity:"BASIC",  slot:"weapon" },
    { key:"ar_cloth", name:"Armure l√©g√®re",   rarity:"BASIC",  slot:"armor"  },
    { key:"am_pebble",name:"Pierre mate",     rarity:"BASIC",  slot:"amulet" },
    { key:"wp_bow",   name:"Arc rudimentaire",rarity:"BASIC",  slot:"weapon" },
    { key:"ar_hide",  name:"Cuir brut",       rarity:"BASIC",  slot:"armor"  },
    { key:"am_ash",   name:"Perle de cendre", rarity:"BASIC",  slot:"amulet" },
    { key:"wp_dagger",name:"Dague rouill√©e",  rarity:"BASIC",  slot:"weapon" },
  ],
  RARE: [
    { key:"wp_steel", name:"√âp√©e d'acier",     rarity:"RARE",   slot:"weapon" },
    { key:"ar_chain", name:"Cotte de mailles", rarity:"RARE",   slot:"armor"  },
    { key:"am_spark", name:"Amulette vive",    rarity:"RARE",   slot:"amulet" },
    { key:"wp_mace",  name:"Masse lourde",     rarity:"RARE",   slot:"weapon" },
    { key:"ar_scale", name:"Armure d'√©cailles",rarity:"RARE",   slot:"armor"  },
    { key:"am_boost", name:"Pierre d'√©lan",    rarity:"RARE",   slot:"amulet" },
  ],
  SUPREME: [
    { key:"wp_legend",  name:"Lame draconique",  rarity:"SUPREME", slot:"weapon" },
    { key:"ar_legend",  name:"Armure du dragon", rarity:"SUPREME", slot:"armor"  },
    { key:"am_legend",  name:"√Çme draconique",   rarity:"SUPREME", slot:"amulet" },
    { key:"wp_phoenix", name:"Griffe du Ph√©nix", rarity:"SUPREME", slot:"weapon" },
    { key:"am_rune",    name:"Rune √©ternelle",   rarity:"SUPREME", slot:"amulet" },
  ]
};
function doChest(type){
  let cost = 0, pool = [];
  if(type==="BASIC"){ cost=1000; pool=ITEM_POOL.BASIC; }
  if(type==="RARE"){ cost=5000; pool=ITEM_POOL.RARE; }
  if(type==="SUPREME"){ cost=15000; pool=ITEM_POOL.SUPREME; }

  if(S.gold < cost){ alert("Pas assez d'or."); return; }
  S.gold -= cost; $('gold').textContent = fmt(S.gold);

  const item = pool[Math.floor(Math.random()*pool.length)];
  S.items.push({ key:item.key, name:item.name, rarity:item.rarity, slot:item.slot, equippedBy:null });
  save();

  const grid = $('chestResults');
  if(grid){
    const card = document.createElement('div');
    card.className = 'slot';
    card.innerHTML = `<div class="big">üéÅ</div><div>${item.name}</div>
                      <div class="badgeR r-${item.rarity.toLowerCase()}">${item.rarity}</div>`;
    grid.innerHTML = ""; grid.appendChild(card);
  }
  renderBag();
  renderDex();
}

/* ===== √âquipement & bonus ===== */
const EQ_BONUS = {
  weapon:  { BASIC:{atk:4},  RARE:{atk:7},   EPIC:{atk:11},  LEGEND:{atk:16},  SUPREME:{atk:22} },
  armor:   { BASIC:{def:2},  RARE:{def:4},   EPIC:{def:6},   LEGEND:{def:8},   SUPREME:{def:10} },
  amulet:  { BASIC:{hp:40},  RARE:{hp:70},   EPIC:{hp:110},  LEGEND:{hp:160},  SUPREME:{hp:220} }
};
function effectiveStats(d){
  const base = { hpMax:d.hpMax, atk:d.atk, def:d.def, atkRate:d.atkRate };
  const eq = d.eq || {};
  ['weapon','armor','amulet'].forEach(slot=>{
    const it = eq[slot];
    if(!it) return;
    const b = EQ_BONUS[slot]?.[it.rarity]; if(!b) return;
    if(b.atk) base.atk += b.atk;
    if(b.def) base.def += b.def;
    if(b.hp)  base.hpMax += b.hp;
  });
  return base;
}
function applyEffectiveToAlly(){
  const src = S.team[0] || S.ally;
  const e = effectiveStats(src);
  S.ally.hpMax = e.hpMax;
  S.ally.atk   = e.atk;
  S.ally.def   = e.def;
  S.ally.hp = Math.min(S.ally.hp, S.ally.hpMax);
}

/* ===== UI ===== */
function ui(){
  $('lvl').textContent = S.lvl;
  $('gold').textContent = fmt(S.gold);
  $('gems').textContent = fmt(S.gems);

  $('allySprite').textContent = S.ally.emoji;
  $('allyName').textContent = `${S.ally.name} ‚Äî ${S.ally.rarity}`;
  $('aHp').textContent = S.ally.hp; $('aHpM').textContent = S.ally.hpMax;
  $('aAtk').textContent = S.ally.atk; $('aDef').textContent = S.ally.def;
  $('allyBar').style.width = (S.ally.hp/S.ally.hpMax*100)+'%';

  $('s1').onclick=()=>setSpeed(1);
  $('s2').onclick=()=>setSpeed(2);
  $('s3').onclick=()=>setSpeed(3);

  // menu & panel
  const ham = $('ham'), menu = $('menu'), overlay=$('overlay'), panel=$('panel');
  ham.onclick = ()=> menu.classList.toggle('open');

  menu.querySelectorAll('a').forEach(a=>{
    a.onclick=(e)=>{e.preventDefault(); menu.classList.remove('open'); openPanel(a.dataset.tab);};
  });
  document.querySelectorAll('.chip[data-tab]').forEach(ch=>{
    ch.onclick=()=>openPanel(ch.dataset.tab);
  });
  $('closePanel').onclick=closePanel;
  overlay.onclick=closePanel;

  renderTeamGrid();
  renderCollectionGrid();
  renderBag();
}
function openPanel(tab){
  $('overlay').classList.add('show'); $('panel').classList.add('show');
  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('.sec').forEach(s=>s.classList.remove('active'));
  document.querySelector(`.chip[data-tab="${tab}"]`)?.classList.add('active');
  document.getElementById(`sec-${tab}`)?.classList.add('active');
  if(tab==='summon'){ hookSummonButtons(); }
  if(tab==='dex'){ renderDex(); }
  if(tab==='equip'){ renderEquipUI(); }
  if(tab==='promo'){ const i=$('promoInput'); if(i) i.value=''; }
}
function closePanel(){ $('overlay').classList.remove('show'); $('panel').classList.remove('show'); }

function renderTeamGrid(){
  const g = $('teamGrid'); g.innerHTML="";
  for(let i=0;i<5;i++){
    const d = S.team[i];
    const div = document.createElement('div'); div.className='slot';
    if(d){
      div.innerHTML = `<div class="big">${d.emoji}</div><div>${d.name}</div>
                       <div class="sub">${d.rarity} ‚Ä¢ PV ${d.hpMax} ‚Ä¢ ATK ${d.atk} ‚Ä¢ DEF ${d.def}</div>
                       <div class="center"><button class="btn" data-i="${i}" data-act="equip">√âquipement</button>
                       <button class="btn" data-i="${i}" data-act="clear">Retirer</button></div>`;
      div.onclick = (e)=>{
        if(e.target.dataset.act==='clear'){ S.team[i]=null; save(); renderTeamGrid(); return; }
        openEquipFor(i);
      };
    }else{
      div.innerHTML = `<div class="big">‚ûï</div><div>Slot ${i+1}</div><div class="sub">Appuie pour choisir</div>`;
      div.onclick = ()=> chooseFromCollection(i);
    }
    g.appendChild(div);
  }
}
function renderCollectionGrid(){
  const g = $('collectionGrid'); g.innerHTML="";
  if(!S.collection.length){
    const d = document.createElement('div'); d.className='note'; d.style.gridColumn='1/-1';
    d.textContent = "Aucun dino. Fais un tirage !";
    g.appendChild(d); return;
  }
  S.collection.forEach(d=>{
    const div = document.createElement('div'); div.className='slot';
    div.innerHTML = `<div class="big">${d.emoji}</div><div>${d.name}</div>
                     <div class="badgeR r-${d.rarity.toLowerCase()}">${d.rarity}</div>`;
    g.appendChild(div);
  });
}
function chooseFromCollection(slotIndex){
  if(!S.collection.length){ alert("Tu n'as pas encore de dinos. Fais un tirage !"); return; }
  const names = S.collection.map((d,idx)=>`${idx+1}. ${d.name} (${d.rarity})`).join('\n');
  const idx = parseInt(prompt(`Choisis un dino pour le slot ${slotIndex+1}:\n${names}`)||"0",10)-1;
  if(idx>=0 && idx<S.collection.length){
    const t = S.collection[idx];
    S.team[slotIndex] = { ...t, hp:t.hpMax, eq: t.eq || {weapon:null,armor:null,amulet:null} };
    if(slotIndex===0){ S.ally = { ...S.team[0] }; applyEffectiveToAlly(); ui(); }
    save(); renderTeamGrid();
  }
}

/* Tirage dinos */
function hookSummonButtons(){
  const b1 = $('pull1'), b10 = $('pull10');
  if(b1) b1.onclick=()=>doSummon(1);
  if(b10) b10.onclick=()=>doSummon(10);
}
function doSummon(n){
  const cost = n===1?100:1000;
  if(S.gems < cost){ alert("Pas assez de gemmes."); return; }
  S.gems -= cost; $('gems').textContent = fmt(S.gems);

  const results = [];
  for(let i=0;i<n;i++){
    const rar = pickRarity();
    const pool = poolByRarity(rar);
    const picked = pool[Math.floor(Math.random()*pool.length)];
    const dino = cloneDino(picked);
    S.collection.push(dino);
    results.push(dino);
  }
  save(); renderCollectionGrid(); renderTeamGrid(); renderDex();

  const grid = $('pullResults'); if(grid){ grid.innerHTML = "";
    results.forEach(d=>{
      const card = document.createElement('div'); card.className='slot';
      card.innerHTML = `<div class="big">${d.emoji}</div><div>${d.name}</div>
                        <div class="badgeR r-${d.rarity.toLowerCase()}">${d.rarity}</div>`;
      grid.appendChild(card);
    });
  }
}

/* Inventaire */
function renderBag(){
  const g = $('bagGrid'); g.innerHTML="";
  if(!S.items.length){
    for(let i=0;i<18;i++){ const c=document.createElement('div'); c.className='slot'; c.textContent='‚Äî'; g.appendChild(c); }
  }else{
    S.items.forEach(it=>{
      const c=document.createElement('div'); c.className='slot';
      const eq= it.equippedBy!=null ? ' (√©quip√©)' : '';
      c.innerHTML = `<div>${it.name}${eq}</div><div class="badgeR r-${(it.rarity||'BASIC').toLowerCase()}">${it.rarity||'BASIC'}</div>`;
      g.appendChild(c);
    });
  }
}

/* Classeur */
const ALL_DINOS = [
  { key:"b_raptor", name:"Petit Raptor", emoji:"ü¶ï", rarity:"BASIC" },
  { key:"r_raptor_agile", name:"Raptor Agile", emoji:"ü¶ñ", rarity:"RARE" },
  { key:"r_stegosprint", name:"Stego Sprint", emoji:"ü¶ï", rarity:"RARE" },
  { key:"r_pachyfrappe", name:"Pachy Frappe", emoji:"ü¶é", rarity:"RARE" },
  { key:"r_spinolette", name:"Spinolette", emoji:"ü¶ñ", rarity:"RARE" },
  { key:"r_anky_sentinelle", name:"Anky Sentinelle", emoji:"ü¶é", rarity:"RARE" },
  { key:"e_triceracorps", name:"Tric√©racorps", emoji:"ü¶ï", rarity:"EPIC" },
  { key:"e_baryon_dash", name:"Baryon Dash", emoji:"ü¶ñ", rarity:"EPIC" },
  { key:"e_kentro_guard", name:"Kentrogarde", emoji:"ü¶é", rarity:"EPIC" },
  { key:"e_cerato_eclair", name:"C√©rato √âclair", emoji:"ü¶ñ", rarity:"EPIC" },
  { key:"l_trex_alpha", name:"T-Rex Alpha", emoji:"ü¶ñ", rarity:"LEGEND" },
  { key:"l_spino_royal", name:"Spino Royal", emoji:"üêâ", rarity:"LEGEND" },
  { key:"l_giga_roc", name:"Giga Roc", emoji:"ü¶ñ", rarity:"LEGEND" },
  { key:"s_dragon_ancien", name:"Dragon Ancien", emoji:"üê≤", rarity:"SUPREME" },
];
const UPGRADE_ITEMS = [
  { key:"wp_basic", name:"√âp√©e en bois", slot:"weapon", rarity:"BASIC" },
  { key:"ar_basic", name:"Bouclier simple", slot:"armor", rarity:"BASIC" },
  { key:"am_basic", name:"Amulette terne", slot:"amulet", rarity:"BASIC" },
  { key:"wp_steel", name:"√âp√©e d'acier", slot:"weapon", rarity:"RARE" },
  { key:"ar_chain", name:"Cotte de mailles", slot:"armor", rarity:"RARE" },
  { key:"am_spark", name:"Amulette vive", slot:"amulet", rarity:"RARE" },
  { key:"wp_legend", name:"Lame draconique", slot:"weapon", rarity:"SUPREME" },
  { key:"ar_legend", name:"Armure du dragon", slot:"armor", rarity:"SUPREME" },
  { key:"am_legend", name:"√Çme draconique", slot:"amulet", rarity:"SUPREME" },
  { key:"wp_phoenix", name:"Griffe du Ph√©nix", slot:"weapon", rarity:"SUPREME" },
  { key:"am_rune", name:"Rune √©ternelle", slot:"amulet", rarity:"SUPREME" },
];
function hasDinoInCollection(name){ return S.collection?.some(d=>d.name===name); }
function rarityClass(r){ return ({BASIC:'basic',RARE:'rare',EPIC:'epic',LEGEND:'legend',SUPREME:'supreme'})[r]||'basic'; }
function renderDex(){
  const dG = $('dexDinos'); dG.innerHTML='';
  ALL_DINOS.forEach(ref=>{
    const owned = hasDinoInCollection(ref.name);
    const card = document.createElement('div');
    card.className = 'dex-card' + (owned? '' : ' locked');
    card.innerHTML = `<div class="big">${ref.emoji}</div>
                      <div>${ref.name}</div>
                      <div class="tag ${rarityClass(ref.rarity)}">${ref.rarity}</div>`;
    dG.appendChild(card);
  });
  const uG = $('dexUpgrades'); uG.innerHTML='';
  UPGRADE_ITEMS.forEach(ref=>{
    const owned = S.items?.some(it=>it.key===ref.key) || false;
    const icon = ref.slot==='weapon'?'üó°Ô∏è': ref.slot==='armor'?'üõ°Ô∏è':'üîÆ';
    const card = document.createElement('div');
    card.className = 'dex-card' + (owned? '' : ' locked');
    card.innerHTML = `<div class="big">${icon}</div>
                      <div>${ref.name}</div>
                      <div class="tag ${rarityClass(ref.rarity)}">${ref.rarity}</div>`;
    uG.appendChild(card);
  });
}

/* √âquipement UI */
let _equipIndex = null;
function openEquipFor(i){
  const d = S.team[i];
  if(!d){ alert("Aucun dino dans ce slot."); return; }
  _equipIndex = i;
  openPanel('equip');
  renderEquipUI();
}
function renderEquipUI(){
  const d = S.team[_equipIndex];
  if(!d) return;
  d.eq = d.eq || {weapon:null,armor:null,amulet:null};
  $('equipTarget').textContent = `${d.name} ‚Äî ${d.rarity}`;
  ['weapon','armor','amulet'].forEach(slot=>{
    const box = $('eq-'+slot);
    const it = d.eq[slot];
    const icon = slot==='weapon'?'üó°Ô∏è':slot==='armor'?'üõ°Ô∏è':'üîÆ';
    if(it){
      box.classList.remove('eqEmpty');
      box.innerHTML = `<div class="big">${icon}</div><div>${it.name}</div><div class="badgeR r-${it.rarity.toLowerCase()}">${it.rarity}</div>`;
    }else{
      box.classList.add('eqEmpty');
      box.innerHTML = `<div class="big">${icon}</div><div>Aucune</div>`;
    }
  });
  $('eqListWrap').innerHTML = '';
}
function openEquipList(slot){
  const list = S.items.filter(it=>!it.equippedBy && it.slot===slot);
  const wrap = $('eqListWrap'); wrap.innerHTML = '';
  if(!list.length){ wrap.innerHTML = `<div class="note">Aucun objet ${slot} disponible.</div>`; return; }
  list.forEach((it)=>{
    const row = document.createElement('div'); row.className='eqItem';
    row.innerHTML = `<div>${it.name} <small>(${it.rarity})</small></div><button class="btn">√âquiper</button>`;
    row.querySelector('button').onclick = ()=> equipTo(slot, it);
    wrap.appendChild(row);
  });
}
function equipTo(slot, item){
  const d = S.team[_equipIndex];
  if(!d) return;
  if(d.eq[slot]){
    const old = d.eq[slot];
    const back = S.items.find(it=>it.key===old.key && it.equippedBy===_equipIndex);
    if(back) back.equippedBy = null;
  }
  d.eq[slot] = { key:item.key, name:item.name, rarity:item.rarity, slot:item.slot };
  const inBag = S.items.find(it=>it===item);
  if(inBag) inBag.equippedBy = _equipIndex;

  if(_equipIndex===0){ S.ally = { ...d, hp: Math.min(S.ally.hp, d.hpMax) }; applyEffectiveToAlly(); ui(); }
  save(); renderEquipUI(); renderTeamGrid(); renderBag();
}
function unequipFromSlot(slot){
  const d = S.team[_equipIndex];
  if(!d || !d.eq[slot]) return;
  const old = d.eq[slot];
  const back = S.items.find(it=>it.key===old.key && it.equippedBy===_equipIndex);
  if(back) back.equippedBy = null;
  d.eq[slot] = null;

  if(_equipIndex===0){ applyEffectiveToAlly(); ui(); }
  save(); renderEquipUI(); renderTeamGrid(); renderBag();
}

/* Combat */
function toast(t){ $('log').textContent = t; }
function setSpeed(v){ S.speed=v; toast(`Vitesse x${v}`); save(); }
function renderAlly(){
  $('allyBar').style.width = (S.ally.hp/S.ally.hpMax*100)+'%';
  $('aHp').textContent = S.ally.hp;
  $('allyName').textContent = `${S.ally.name} ‚Äî ${S.ally.rarity}`;
  $('allySprite').textContent = S.ally.emoji;
  $('aAtk').textContent = S.ally.atk; $('aDef').textContent = S.ally.def; $('aHpM').textContent = S.ally.hpMax;
}
function restartLevel(){
  S.ally.hp = S.ally.hpMax;
  newEnemy(); renderAlly();
  S._tA = 0; S._tE = 0;
  toast("D√©faite. Tu recommences le niveau !");
  save();
}
function tick(now){
  const dt = Math.min(0.12,(now - S.last)/1000)*S.speed; S.last = now;
  S._tA += dt; S._tE += dt;

  if(S._tA >= S.ally.atkRate){
    S._tA -= S.ally.atkRate;
    const dmg = Math.max(1, S.ally.atk - S.enemy.def);
    S.enemy.hp = clamp(S.enemy.hp - dmg, 0, S.enemy.hpMax);
    document.querySelector('.box').classList.add('hit'); setTimeout(()=>document.querySelector('.box').classList.remove('hit'),80);
    $('enemyBar').style.width = (S.enemy.hp/S.enemy.hpMax*100)+'%';
    if(S.enemy.hp<=0){
      const base = 8 + Math.floor(S.lvl*1.6);
      const gain = S.enemy.boss ? base*4 : base;
      S.gold += gain;
      if(S.enemy.boss){ S.gems += 10; toast(`Boss vaincu ! +${gain} or ‚Ä¢ +10 gemmes`); }
      else toast(`Ennemi vaincu ! +${gain} or`);
      S.lvl++; $('gold').textContent=fmt(S.gold); $('gems').textContent=fmt(S.gems); $('lvl').textContent=S.lvl;
      S.ally.hp = clamp(S.ally.hp + Math.ceil(S.ally.hpMax*0.18),0,S.ally.hpMax); renderAlly();
      newEnemy(); save();
    }
  }

  if(S._tE >= 1.45){
    S._tE -= 1.45;
    const dmg = Math.max(1, S.enemy.atk - S.ally.def);
    S.ally.hp = clamp(S.ally.hp - dmg, 0, S.ally.hpMax);
    document.querySelector('.box-ally').classList.add('hit'); setTimeout(()=>document.querySelector('.box-ally').classList.remove('hit'),80);
    renderAlly();
    if(S.ally.hp<=0){
      restartLevel();
      return;
    }
  }
  requestAnimationFrame(tick);
}

/* Code promo */
const PROMO_CODES = {
  "TESTDINO": { gold: 200000, gems: 50000, msg: "Pack test ULTRA re√ßu ! ü¶ñüíé" },
};
function redeemPromo(){
  const code = ($('promoInput')?.value||'').trim().toUpperCase();
  if (!code){ toast("Entre un code"); return; }
  if (S.usedCodes.includes(code)) { toast("Code d√©j√† utilis√©"); return; }
  const reward = PROMO_CODES[code];
  if (!reward){ toast("Code invalide"); return; }

  if (reward.gold) S.gold += reward.gold;
  if (reward.gems) S.gems += reward.gems;
  if (reward.item) S.items.push({ key: reward.item, name: reward.item, rarity:"BASIC", slot:"weapon" });
  if (reward.dino) S.collection.push(reward.dino);

  S.usedCodes.push(code);
  save(); ui(); renderBag(); renderCollectionGrid(); renderDex();
  toast(reward.msg || "R√©compense re√ßue !");
}

/* Boot */
load();
if(!S.collection || !S.collection.length){
  const base = POOL.find(d=>d.rarity==="BASIC");
  S.collection = [ cloneDino(base) ];
}
if(!S.team[0]){ S.team[0] = { ...S.collection[0] }; S.ally = { ...S.team[0] }; }
ui();
applyEffectiveToAlly();
setWorld(S.lvl);
newEnemy();
renderBag();
renderDex();
requestAnimationFrame((t)=>{ S.last=t; tick(t); });
</script>
<script>
// Ouvre / ferme le menu
const ham = document.getElementById("ham");
const menu = document.getElementById("menu");

ham.addEventListener("click", () => {
  menu.classList.toggle("open");
});

// Ferme le menu quand on clique ailleurs
document.addEventListener("click", (e) => {
  if (!menu.contains(e.target) && !ham.contains(e.target)) {
    menu.classList.remove("open");
  }
});
</script>
</body>
</html>